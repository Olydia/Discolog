<?xml version="1.0" encoding="UTF-8"?>
<taskModel xmlns="http://www.cs.wpi.edu/~rich/cetask/cea-2018-ext"
           xmlns:disco="urn:disco.wpi.edu:Disco"
           xmlns:n="urn:negotiate.limsi.fr:Negotiate"
           about="urn:negotiate.limsi.fr:Example">
   <task id="InviteOut">
      <subtasks id="_InviteOut_subtasks">
         <step name="_InviteOut_step" task="disco:Say"/>
         <step name="_InviteOut_ref" task="_InviteOut_tree"/>
         <binding slot="$_InviteOut_step.text"
                  value="&#34;Would you like to go out with me on the town tonight?&#34;"/>
         <binding slot="$_InviteOut_step.external" value="false"/>
      </subtasks>
   </task>
   <task id="InviteToDinner">
      <subtasks id="_InviteToDinner_subtasks">
         <step name="_InviteToDinner_step" task="disco:Say"/>
         <step name="_InviteToDinner_ref" task="_InviteToDinner_tree"/>
         <binding slot="$_InviteToDinner_step.text"
                  value="&#34;Would you enjoy having dinner with me?&#34;"/>
         <binding slot="$_InviteToDinner_step.external" value="false"/>
      </subtasks>
   </task>
   <task id="ClosingDialogue">
      <subtasks id="_ClosingDialogue_subtasks">
         <step name="_ClosingDialogue_step" task="disco:Say"/>
         <step name="_ClosingDialogue_ref" task="_ClosingDialogue_tree"/>
         <binding slot="$_ClosingDialogue_step.text" value="&#34;No problem, another day maybe&#34;"/>
         <binding slot="$_ClosingDialogue_step.external" value="false"/>
      </subtasks>
   </task>
   <task id="ClosingNegotiation">
      <subtasks id="_ClosingNegotiation_subtasks">
         <step name="_ClosingNegotiation_step" task="disco:Say"/>
         <step name="_ClosingNegotiation_ref" task="_ClosingNegotiation_tree"/>
         <binding slot="$_ClosingNegotiation_step.text"
                  value="&#34;Sorry, but I no longer want to go for dinner. You rejected all the restaurants that I like&#34;"/>
         <binding slot="$_ClosingNegotiation_step.external" value="false"/>
      </subtasks>
   </task>
   <task id="Booking">
      <subtasks id="_Booking_subtasks">
         <step name="_Booking_step" task="disco:Say"/>
         <step name="_Booking_ref" task="_Booking_tree"/>
         <binding slot="$_Booking_step.text" value="&#34;Okay, I'll call to book a table&#34;"/>
         <binding slot="$_Booking_step.external" value="false"/>
      </subtasks>
   </task>
   <task id="AskCriterion">
      <subtasks id="_AskCriterion_subtasks">
         <step name="_AskCriterion_step" task="n:fr.limsi.negotiate.lang.AskPreference"/>
         <step name="_AskCriterion_ref" task="_AskCriterion_tree"/>
         <binding slot="$_AskCriterion_step.external" value="false"/>
         <binding slot="$_AskCriterion_step.criterion" value="$mostPrefCriterion"/>
         <binding slot="$_AskCriterion_step.less" value="null"/>
         <binding slot="$_AskCriterion_step.more" value="null"/>
      </subtasks>
   </task>
   <task id="ProposeCriterion">
      <subtasks id="_ProposeCriterion_subtasks">
         <step name="_ProposeCriterion_step" task="n:fr.limsi.negotiate.lang.Propose"/>
         <step name="_ProposeCriterion_ref" task="_ProposeCriterion_tree"/>
         <binding slot="$_ProposeCriterion_step.external" value="false"/>
         <binding slot="$_ProposeCriterion_step.proposal"
                  value="createProposal($introMostPrefValue, true) "/>
      </subtasks>
   </task>
   <task id="State">
      <subtasks id="_State_subtasks">
         <step name="_State_step" task="n:fr.limsi.negotiate.lang.StatePreference"/>
         <step name="_State_ref" task="_State_tree"/>
         <binding slot="$_State_step.external" value="true"/>
      </subtasks>
   </task>
   <task id="Ask">
      <subtasks id="_Ask_subtasks">
         <step name="_Ask_step" task="n:fr.limsi.negotiate.lang.AskPreference"/>
         <step name="_Ask_ref" task="_Ask_tree"/>
         <binding slot="$_Ask_step.external" value="true"/>
      </subtasks>
   </task>
   <task id="Propose">
      <subtasks id="_Propose_subtasks">
         <step name="_Propose_step" task="n:fr.limsi.negotiate.lang.Propose"/>
         <step name="_Propose_ref" task="_Propose_tree"/>
         <binding slot="$_Propose_step.external" value="true"/>
      </subtasks>
   </task>
   <task id="Accept">
      <subtasks id="_Accept_subtasks">
         <step name="_Accept_step" task="n:fr.limsi.negotiate.lang.Accept"/>
         <step name="_Accept_ref" task="_Accept_tree"/>
         <binding slot="$_Accept_step.external" value="true"/>
      </subtasks>
   </task>
   <task id="Reject">
      <subtasks id="_Reject_subtasks">
         <step name="_Reject_step" task="n:fr.limsi.negotiate.lang.Reject"/>
         <step name="_Reject_ref" task="_Reject_tree"/>
         <binding slot="$_Reject_step.external" value="true"/>
      </subtasks>
   </task>
   <task id="_AskCriterion_tree">
      <subtasks id="_d4e45_subtasks">
         <step name="_d4e45_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e46_subtasks">
         <step name="_d4e46_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e47_subtasks">
         <step name="_d4e47_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e48_subtasks">
         <step name="_d4e48_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e49_subtasks">
         <step name="_d4e49_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_ProposeCriterion_tree">
      <subtasks id="_d4e51_subtasks">
         <step name="_d4e51_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e52_subtasks">
         <step name="_d4e52_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e53_subtasks">
         <step name="_d4e53_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e54_subtasks">
         <step name="_d4e54_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e55_subtasks">
         <step name="_d4e55_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_State_tree">
      <subtasks id="_d4e59_subtasks">
         <step name="_d4e59_step" task="ClosingNegotiation"/>
         <applicable>$negotiation.negotiationFailure(relation)</applicable>
         <binding slot="$_d4e59_step.external" value="false"/>
      </subtasks>
      <subtasks id="_d4e60_subtasks">
         <step name="_d4e60_step" task="n:fr.limsi.negotiate.lang.Propose"/>
         <step name="_d4e60_ref" task="_d4e60_tree"/>
         <applicable>proposalFromUserState(getLastUserPref(), relation)</applicable>
         <binding slot="$_d4e60_step.external" value="false"/>
         <binding slot="$_d4e60_step.proposal"
                  value="proposalFromPreference(getLastUserPref(), true) "/>
      </subtasks>
      <subtasks id="_d4e66_subtasks">
         <step name="_d4e66_step" task="n:fr.limsi.negotiate.lang.Propose"/>
         <step name="_d4e66_ref" task="_d4e66_tree"/>
         <applicable>isMaxStated()</applicable>
         <binding slot="$_d4e66_step.external" value="false"/>
         <binding slot="$_d4e66_step.proposal" value="$negotiation.computeProposal(relation)"/>
      </subtasks>
      <subtasks id="_d4e72_subtasks">
         <step name="_d4e72_step" task="n:fr.limsi.negotiate.lang.Propose"/>
         <step name="_d4e72_ref" task="_d4e72_tree"/>
         <applicable>isDom()&amp;&amp; $negotiation.getPossibleProposalOptions(relation).isEmpty()</applicable>
         <binding slot="$_d4e72_step.external" value="false"/>
         <binding slot="$_d4e72_step.proposal"
                  value="createProposal(currentMostPreferred(currentDiscussedCriterion(), relation), true)"/>
      </subtasks>
      <subtasks id="_d4e78_subtasks">
         <step name="_d4e78_step" task="n:fr.limsi.negotiate.lang.Propose"/>
         <step name="_d4e78_ref" task="_d4e78_tree"/>
         <applicable>isDom()</applicable>
         <binding slot="$_d4e78_step.external" value="false"/>
         <binding slot="$_d4e78_step.proposal"
                  value="createProposal($negotiation.getPossibleProposalOptions(relation).get(0), true) "/>
      </subtasks>
      <subtasks id="_d4e84_subtasks">
         <step name="_d4e84_step" task="n:fr.limsi.negotiate.lang.StatePreference"/>
         <step name="_d4e84_ref" task="_d4e84_tree"/>
         <applicable>$negotiation.statedValues(currentDiscussedCriterion()) </applicable>
         <binding slot="$_d4e84_step.external" value="false"/>
         <binding slot="$_d4e84_step.less" value="reactUser($state).getLess()"/>
         <binding slot="$_d4e84_step.more" value="reactUser($state).getMore()"/>
      </subtasks>
      <subtasks id="_d4e91_subtasks">
         <step name="_d4e91_step" task="n:fr.limsi.negotiate.lang.AskPreference"/>
         <step name="_d4e91_ref" task="_d4e91_tree"/>
         <applicable>isSub() &amp;&amp; $negotiation.statedValues(openNewCriterion())</applicable>
         <binding slot="$_d4e91_step.external" value="false"/>
         <binding slot="$_d4e91_step.criterion" value="openNewCriterion()"/>
         <binding slot="$_d4e91_step.less" value="null"/>
         <binding slot="$_d4e91_step.more" value="null"/>
      </subtasks>
      <subtasks id="_d4e97_subtasks">
         <step name="_d4e97_step" task="n:fr.limsi.negotiate.lang.StatePreference"/>
         <step name="_d4e97_ref" task="_d4e97_tree"/>
         <applicable>isPeer() &amp;&amp; $negotiation.statedValues(openNewCriterion())</applicable>
         <binding slot="$_d4e97_step.external" value="false"/>
         <binding slot="$_d4e97_step.less" value="getPreference(openNewCriterion()).getLess()"/>
         <binding slot="$_d4e97_step.more" value="getPreference(openNewCriterion()).getMore()"/>
      </subtasks>
   </task>
   <task id="_d4e60_tree">
      <subtasks id="_d4e61_subtasks">
         <step name="_d4e61_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e62_subtasks">
         <step name="_d4e62_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e63_subtasks">
         <step name="_d4e63_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e64_subtasks">
         <step name="_d4e64_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e65_subtasks">
         <step name="_d4e65_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e66_tree">
      <subtasks id="_d4e67_subtasks">
         <step name="_d4e67_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e68_subtasks">
         <step name="_d4e68_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e69_subtasks">
         <step name="_d4e69_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e70_subtasks">
         <step name="_d4e70_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e71_subtasks">
         <step name="_d4e71_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e72_tree">
      <subtasks id="_d4e73_subtasks">
         <step name="_d4e73_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e74_subtasks">
         <step name="_d4e74_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e75_subtasks">
         <step name="_d4e75_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e76_subtasks">
         <step name="_d4e76_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e77_subtasks">
         <step name="_d4e77_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e78_tree">
      <subtasks id="_d4e79_subtasks">
         <step name="_d4e79_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e80_subtasks">
         <step name="_d4e80_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e81_subtasks">
         <step name="_d4e81_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e82_subtasks">
         <step name="_d4e82_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e83_subtasks">
         <step name="_d4e83_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e84_tree">
      <subtasks id="_d4e85_subtasks">
         <step name="_d4e85_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e86_subtasks">
         <step name="_d4e86_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e87_subtasks">
         <step name="_d4e87_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e88_subtasks">
         <step name="_d4e88_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e89_subtasks">
         <step name="_d4e89_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e91_tree">
      <subtasks id="_d4e92_subtasks">
         <step name="_d4e92_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e93_subtasks">
         <step name="_d4e93_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e94_subtasks">
         <step name="_d4e94_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e95_subtasks">
         <step name="_d4e95_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e96_subtasks">
         <step name="_d4e96_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e97_tree">
      <subtasks id="_d4e98_subtasks">
         <step name="_d4e98_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e99_subtasks">
         <step name="_d4e99_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e100_subtasks">
         <step name="_d4e100_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e101_subtasks">
         <step name="_d4e101_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e102_subtasks">
         <step name="_d4e102_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_Ask_tree">
      <subtasks id="_d4e104_subtasks">
         <step name="_d4e104_step" task="ClosingNegotiation"/>
         <applicable>$negotiation.negotiationFailure(relation)</applicable>
         <binding slot="$_d4e104_step.external" value="false"/>
      </subtasks>
      <subtasks id="_d4e105_subtasks">
         <step name="_d4e105_step" task="n:fr.limsi.negotiate.lang.StatePreference"/>
         <step name="_d4e105_ref" task="_d4e105_tree"/>
         <binding slot="$_d4e105_step.external" value="false"/>
         <binding slot="$_d4e105_step.less" value="reactUser($ask).getLess()"/>
         <binding slot="$_d4e105_step.more" value="reactUser($ask).getMore()"/>
      </subtasks>
   </task>
   <task id="_d4e105_tree">
      <subtasks id="_d4e106_subtasks">
         <step name="_d4e106_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e107_subtasks">
         <step name="_d4e107_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e108_subtasks">
         <step name="_d4e108_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e109_subtasks">
         <step name="_d4e109_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e110_subtasks">
         <step name="_d4e110_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_Propose_tree">
      <subtasks id="_d4e112_subtasks">
         <step name="_d4e112_step" task="ClosingDialogue"/>
         <applicable>$negotiation.negotiationFailure(relation)</applicable>
         <binding slot="$_d4e112_step.external" value="false"/>
      </subtasks>
      <subtasks id="_d4e114_subtasks">
         <step name="_d4e114_step" task="Booking"/>
         <applicable>isOptionProposal(lastOpenProposal())  &amp;&amp; isAcceptable(lastOpenProposal(), relation)</applicable>
         <binding slot="$_d4e114_step.external" value="false"/>
      </subtasks>
      <subtasks id="_d4e115_subtasks">
         <step name="_d4e115_step" task="n:fr.limsi.negotiate.lang.Accept"/>
         <step name="_d4e115_ref" task="_d4e115_tree"/>
         <applicable>isAcceptable(lastOpenProposal(), relation)</applicable>
         <binding slot="$_d4e115_step.external" value="false"/>
         <binding slot="$_d4e115_step.proposal" value="lastOpenProposal()"/>
      </subtasks>
      <subtasks id="_d4e121_subtasks">
         <step name="_d4e121_step" task="n:fr.limsi.negotiate.lang.Propose"/>
         <step name="_d4e121_ref" task="_d4e121_tree"/>
         <applicable>isDom() &amp;&amp; !isAcceptable(lastOpenProposal(), relation)</applicable>
         <binding slot="$_d4e121_step.external" value="false"/>
         <binding slot="$_d4e121_step.proposal"
                  value="getRandCriterionProp(getDiscussedCriterion(), relation)"/>
      </subtasks>
      <subtasks id="_d4e127_subtasks">
         <step name="_d4e127_step" task="n:fr.limsi.negotiate.lang.Propose"/>
         <step name="_d4e127_ref" task="_d4e127_tree"/>
         <applicable>isDom() &amp;&amp; !isAcceptable(lastOpenProposal(), relation)</applicable>
         <binding slot="$_d4e127_step.external" value="false"/>
         <binding slot="$_d4e127_step.proposal" value="getRandOptionProp()"/>
      </subtasks>
      <subtasks id="_d4e133_subtasks">
         <step name="_d4e133_step" task="n:fr.limsi.negotiate.lang.StatePreference"/>
         <step name="_d4e133_ref" task="_d4e133_tree"/>
         <applicable>isSub() &amp;&amp; !isAcceptable(lastOpenProposal(), relation)</applicable>
         <binding slot="$_d4e133_step.external" value="false"/>
         <binding slot="$_d4e133_step.less"
                  value="reactToRejectedProp(lastOpenProposal()).getLess()"/>
         <binding slot="$_d4e133_step.more"
                  value="reactToRejectedProp(lastOpenProposal()).getMore()"/>
      </subtasks>
      <subtasks id="_d4e139_subtasks">
         <step name="_d4e139_step" task="n:fr.limsi.negotiate.lang.Reject"/>
         <step name="_d4e139_ref" task="_d4e139_tree"/>
         <applicable>!(isSub() &amp;&amp; isAcceptable(lastOpenProposal(), relation))</applicable>
         <binding slot="$_d4e139_step.external" value="false"/>
         <binding slot="$_d4e139_step.proposal" value="lastOpenProposal()"/>
      </subtasks>
   </task>
   <task id="_d4e115_tree">
      <subtasks id="_d4e116_subtasks">
         <step name="_d4e116_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e117_subtasks">
         <step name="_d4e117_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e118_subtasks">
         <step name="_d4e118_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e119_subtasks">
         <step name="_d4e119_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e120_subtasks">
         <step name="_d4e120_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e121_tree">
      <subtasks id="_d4e122_subtasks">
         <step name="_d4e122_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e123_subtasks">
         <step name="_d4e123_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e124_subtasks">
         <step name="_d4e124_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e125_subtasks">
         <step name="_d4e125_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e126_subtasks">
         <step name="_d4e126_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e127_tree">
      <subtasks id="_d4e128_subtasks">
         <step name="_d4e128_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e129_subtasks">
         <step name="_d4e129_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e130_subtasks">
         <step name="_d4e130_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e131_subtasks">
         <step name="_d4e131_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e132_subtasks">
         <step name="_d4e132_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e133_tree">
      <subtasks id="_d4e134_subtasks">
         <step name="_d4e134_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e135_subtasks">
         <step name="_d4e135_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e136_subtasks">
         <step name="_d4e136_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e137_subtasks">
         <step name="_d4e137_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e138_subtasks">
         <step name="_d4e138_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e139_tree">
      <subtasks id="_d4e140_subtasks">
         <step name="_d4e140_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e141_subtasks">
         <step name="_d4e141_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e142_subtasks">
         <step name="_d4e142_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e143_subtasks">
         <step name="_d4e143_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e144_subtasks">
         <step name="_d4e144_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_Accept_tree">
      <subtasks id="_d4e146_subtasks">
         <step name="_d4e146_step" task="ClosingNegotiation"/>
         <applicable>$negotiation.negotiationFailure(relation)</applicable>
         <binding slot="$_d4e146_step.external" value="false"/>
      </subtasks>
      <subtasks id="_d4e147_subtasks">
         <step name="_d4e147_step" task="Booking"/>
         <applicable>isOptionProposal(lastAcceptedProposal())</applicable>
         <binding slot="$_d4e147_step.external" value="false"/>
      </subtasks>
      <subtasks id="_d4e148_subtasks">
         <step name="_d4e148_step" task="n:fr.limsi.negotiate.lang.Propose"/>
         <step name="_d4e148_ref" task="_d4e148_tree"/>
         <applicable>isSub() &amp;&amp; $negotiation.allCriteriaAccepted()</applicable>
         <binding slot="$_d4e148_step.external" value="false"/>
         <binding slot="$_d4e148_step.proposal"
                  value="createProposal($negotiation.computeAcceptedOption(), true)"/>
      </subtasks>
      <subtasks id="_d4e154_subtasks">
         <step name="_d4e154_step" task="n:fr.limsi.negotiate.lang.Propose"/>
         <step name="_d4e154_ref" task="_d4e154_tree"/>
         <applicable>!isSub() &amp;&amp; isCriterionProposal(lastAcceptedProposal())</applicable>
         <binding slot="$_d4e154_step.external" value="false"/>
         <binding slot="$_d4e154_step.proposal"
                  value="createProposal(getOptionWithValue(lastAcceptedProposal().getValue()), true)"/>
      </subtasks>
      <subtasks id="_d4e160_subtasks">
         <step name="_d4e160_step" task="n:fr.limsi.negotiate.lang.StatePreference"/>
         <step name="_d4e160_ref" task="_d4e160_tree"/>
         <applicable>isPeer()</applicable>
         <binding slot="$_d4e160_step.external" value="false"/>
         <binding slot="$_d4e160_step.less" value="getPreference(openNewCriterion()).getLess()"/>
         <binding slot="$_d4e160_step.more" value="getPreference(openNewCriterion()).getMore()"/>
      </subtasks>
      <subtasks id="_d4e166_subtasks">
         <step name="_d4e166_step" task="n:fr.limsi.negotiate.lang.Propose"/>
         <step name="_d4e166_ref" task="_d4e166_tree"/>
         <applicable>isDom()</applicable>
         <binding slot="$_d4e166_step.external" value="false"/>
         <binding slot="$_d4e166_step.proposal"
                  value="createProposal(currentMostPreferred(openNewCriterion(), relation), true)"/>
      </subtasks>
      <subtasks id="_d4e172_subtasks">
         <step name="_d4e172_step" task="n:fr.limsi.negotiate.lang.AskPreference"/>
         <step name="_d4e172_ref" task="_d4e172_tree"/>
         <applicable>isSub()</applicable>
         <binding slot="$_d4e172_step.external" value="false"/>
         <binding slot="$_d4e172_step.criterion" value="null"/>
         <binding slot="$_d4e172_step.less" value="askUserPref(openNewCriterion()).getLess()"/>
         <binding slot="$_d4e172_step.more" value="askUserPref(openNewCriterion()).getMore()"/>
      </subtasks>
   </task>
   <task id="_d4e148_tree">
      <subtasks id="_d4e149_subtasks">
         <step name="_d4e149_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e150_subtasks">
         <step name="_d4e150_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e151_subtasks">
         <step name="_d4e151_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e152_subtasks">
         <step name="_d4e152_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e153_subtasks">
         <step name="_d4e153_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e154_tree">
      <subtasks id="_d4e155_subtasks">
         <step name="_d4e155_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e156_subtasks">
         <step name="_d4e156_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e157_subtasks">
         <step name="_d4e157_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e158_subtasks">
         <step name="_d4e158_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e159_subtasks">
         <step name="_d4e159_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e160_tree">
      <subtasks id="_d4e161_subtasks">
         <step name="_d4e161_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e162_subtasks">
         <step name="_d4e162_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e163_subtasks">
         <step name="_d4e163_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e164_subtasks">
         <step name="_d4e164_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e165_subtasks">
         <step name="_d4e165_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e166_tree">
      <subtasks id="_d4e167_subtasks">
         <step name="_d4e167_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e168_subtasks">
         <step name="_d4e168_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e169_subtasks">
         <step name="_d4e169_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e170_subtasks">
         <step name="_d4e170_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e171_subtasks">
         <step name="_d4e171_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e172_tree">
      <subtasks id="_d4e173_subtasks">
         <step name="_d4e173_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e174_subtasks">
         <step name="_d4e174_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e175_subtasks">
         <step name="_d4e175_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e176_subtasks">
         <step name="_d4e176_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e177_subtasks">
         <step name="_d4e177_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_Reject_tree">
      <subtasks id="_d4e180_subtasks">
         <step name="_d4e180_step" task="ClosingNegotiation"/>
         <applicable>$negotiation.negotiationFailure(relation)</applicable>
         <binding slot="$_d4e180_step.external" value="false"/>
      </subtasks>
      <subtasks id="_d4e181_subtasks">
         <step name="_d4e181_step" task="n:fr.limsi.negotiate.lang.Propose"/>
         <step name="_d4e181_ref" task="_d4e181_tree"/>
         <applicable> isMostPrefProposal(lastRejectedProposal()) &amp;&amp; isDom()</applicable>
         <binding slot="$_d4e181_step.external" value="false"/>
         <binding slot="$_d4e181_step.proposal" value="lastRejectedProposal() "/>
      </subtasks>
      <subtasks id="_d4e188_subtasks">
         <step name="_d4e188_step" task="n:fr.limsi.negotiate.lang.AskPreference"/>
         <step name="_d4e188_ref" task="_d4e188_tree"/>
         <applicable>!isDom()&amp;&amp; isOptionProposal(lastRejectedProposal())</applicable>
         <binding slot="$_d4e188_step.external" value="false"/>
         <binding slot="$_d4e188_step.criterion" value="null"/>
         <binding slot="$_d4e188_step.less" value="askUserPref(openNewCriterion()).getLess()"/>
         <binding slot="$_d4e188_step.more" value="askUserPref(openNewCriterion()).getMore()"/>
      </subtasks>
      <subtasks id="_d4e194_subtasks">
         <step name="_d4e194_step" task="n:fr.limsi.negotiate.lang.StatePreference"/>
         <step name="_d4e194_ref" task="_d4e194_tree"/>
         <applicable>isDom()&amp;&amp; isOptionProposal(lastRejectedProposal())</applicable>
         <binding slot="$_d4e194_step.external" value="false"/>
         <binding slot="$_d4e194_step.less" value="askUserPref(openNewCriterion()).getLess()"/>
         <binding slot="$_d4e194_step.more" value="askUserPref(openNewCriterion()).getMore()"/>
      </subtasks>
      <subtasks id="_d4e202_subtasks">
         <step name="_d4e202_step" task="n:fr.limsi.negotiate.lang.AskPreference"/>
         <step name="_d4e202_ref" task="_d4e202_tree"/>
         <applicable>isSub()</applicable>
         <binding slot="$_d4e202_step.external" value="false"/>
         <binding slot="$_d4e202_step.criterion" value="null"/>
         <binding slot="$_d4e202_step.less"
                  value="askUserPref(getDiscussedCriterion()).getLess()"/>
         <binding slot="$_d4e202_step.more"
                  value="askUserPref(getDiscussedCriterion()).getMore()"/>
      </subtasks>
      <subtasks id="_d4e209_subtasks">
         <step name="_d4e209_step" task="n:fr.limsi.negotiate.lang.StatePreference"/>
         <step name="_d4e209_ref" task="_d4e209_tree"/>
         <applicable>isPeer()</applicable>
         <binding slot="$_d4e209_step.external" value="false"/>
         <binding slot="$_d4e209_step.less"
                  value="getPreference(getDiscussedCriterion()).getLess()"/>
         <binding slot="$_d4e209_step.more"
                  value="getPreference(getDiscussedCriterion()).getMore()"/>
      </subtasks>
      <subtasks id="_d4e218_subtasks">
         <step name="_d4e218_step" task="n:fr.limsi.negotiate.lang.Propose"/>
         <step name="_d4e218_ref" task="_d4e218_tree"/>
         <applicable>!isSub()</applicable>
         <binding slot="$_d4e218_step.external" value="false"/>
         <binding slot="$_d4e218_step.proposal"
                  value="getRandCriterionProp(getDiscussedCriterion(), relation)"/>
      </subtasks>
      <subtasks id="_d4e224_subtasks">
         <step name="_d4e224_step" task="n:fr.limsi.negotiate.lang.Propose"/>
         <step name="_d4e224_ref" task="_d4e224_tree"/>
         <applicable>!isSub()</applicable>
         <binding slot="$_d4e224_step.external" value="false"/>
         <binding slot="$_d4e224_step.proposal" value="getRandOptionProp()"/>
      </subtasks>
   </task>
   <task id="_d4e181_tree">
      <subtasks id="_d4e182_subtasks">
         <step name="_d4e182_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e183_subtasks">
         <step name="_d4e183_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e184_subtasks">
         <step name="_d4e184_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e185_subtasks">
         <step name="_d4e185_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e186_subtasks">
         <step name="_d4e186_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e188_tree">
      <subtasks id="_d4e189_subtasks">
         <step name="_d4e189_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e190_subtasks">
         <step name="_d4e190_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e191_subtasks">
         <step name="_d4e191_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e192_subtasks">
         <step name="_d4e192_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e193_subtasks">
         <step name="_d4e193_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e194_tree">
      <subtasks id="_d4e195_subtasks">
         <step name="_d4e195_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e196_subtasks">
         <step name="_d4e196_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e197_subtasks">
         <step name="_d4e197_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e198_subtasks">
         <step name="_d4e198_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e199_subtasks">
         <step name="_d4e199_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e202_tree">
      <subtasks id="_d4e203_subtasks">
         <step name="_d4e203_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e204_subtasks">
         <step name="_d4e204_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e205_subtasks">
         <step name="_d4e205_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e206_subtasks">
         <step name="_d4e206_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e207_subtasks">
         <step name="_d4e207_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e209_tree">
      <subtasks id="_d4e210_subtasks">
         <step name="_d4e210_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e211_subtasks">
         <step name="_d4e211_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e212_subtasks">
         <step name="_d4e212_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e213_subtasks">
         <step name="_d4e213_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e214_subtasks">
         <step name="_d4e214_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e218_tree">
      <subtasks id="_d4e219_subtasks">
         <step name="_d4e219_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e220_subtasks">
         <step name="_d4e220_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e221_subtasks">
         <step name="_d4e221_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e222_subtasks">
         <step name="_d4e222_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e223_subtasks">
         <step name="_d4e223_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_d4e224_tree">
      <subtasks id="_d4e225_subtasks">
         <step name="_d4e225_step" task="Ask"/>
      </subtasks>
      <subtasks id="_d4e226_subtasks">
         <step name="_d4e226_step" task="State"/>
      </subtasks>
      <subtasks id="_d4e227_subtasks">
         <step name="_d4e227_step" task="Propose"/>
      </subtasks>
      <subtasks id="_d4e228_subtasks">
         <step name="_d4e228_step" task="Accept"/>
      </subtasks>
      <subtasks id="_d4e229_subtasks">
         <step name="_d4e229_step" task="Reject"/>
      </subtasks>
   </task>
   <task id="_InviteOut_tree">
      <subtasks id="_d4e29_subtasks">
         <step name="_d4e29_step" task="disco:Say"/>
         <step name="_d4e30_step" task="InviteToDinner"/>
         <binding slot="$_d4e29_step.text" value="&#34;That would be great ! .&#34;"/>
         <binding slot="$_d4e29_step.external" value="true"/>
      </subtasks>
      <subtasks id="_d4e31_subtasks">
         <step name="_d4e31_step" task="disco:Say"/>
         <step name="_d4e32_step" task="ClosingDialogue"/>
         <binding slot="$_d4e31_step.text" value="&#34;Sorry, not today&#34;"/>
         <binding slot="$_d4e31_step.external" value="true"/>
      </subtasks>
   </task>
   <task id="_InviteToDinner_tree">
      <subtasks id="_d4e34_subtasks">
         <step name="_d4e34_step" task="disco:Say"/>
         <step name="_d4e35_step" task="AgentFirst"/>
         <binding slot="$_d4e34_step.text" value="&#34;yes.&#34;"/>
         <binding slot="$_d4e34_step.external" value="true"/>
      </subtasks>
   </task>
   <task id="_ClosingDialogue_tree">
      <subtasks id="_d4e37_subtasks">
         <step name="_d4e37_step" task="disco:Say"/>
         <binding slot="$_d4e37_step.text" value="&#34;Sure !.&#34;"/>
         <binding slot="$_d4e37_step.external" value="true"/>
      </subtasks>
      <subtasks id="_d4e38_subtasks">
         <step name="_d4e38_step" task="disco:Say"/>
         <binding slot="$_d4e38_step.text" value="&#34;yeah, I'll call you tommorow.&#34;"/>
         <binding slot="$_d4e38_step.external" value="true"/>
      </subtasks>
   </task>
   <task id="_ClosingNegotiation_tree">
      <subtasks id="_d4e40_subtasks">
         <step name="_d4e40_step" task="disco:Say"/>
         <binding slot="$_d4e40_step.text" value="&#34;Too bad.&#34;"/>
         <binding slot="$_d4e40_step.external" value="true"/>
      </subtasks>
      <subtasks id="_d4e41_subtasks">
         <step name="_d4e41_step" task="disco:Say"/>
         <binding slot="$_d4e41_step.text" value="&#34;No problem.&#34;"/>
         <binding slot="$_d4e41_step.external" value="true"/>
      </subtasks>
   </task>
   <task id="_Booking_tree">
      <subtasks id="_d4e43_subtasks">
         <step name="_d4e43_step" task="disco:Say"/>
         <binding slot="$_d4e43_step.text" value="&#34;Perfect!&#34;"/>
         <binding slot="$_d4e43_step.external" value="true"/>
      </subtasks>
   </task>
   <task id="Top">
      <subtasks id="agentFirst">
         <step name="first" task="AgentFirst"/>
         <applicable> !isSub() </applicable>
      </subtasks>
      <subtasks id="userFirst">
         <step name="first" task="UserFirst"/>
         <applicable> isSub() </applicable>
      </subtasks>
   </task>
   <task id="AgentFirst">
      <subtasks id="askC">
         <step name="ask" task="AskCriterion"/>
         <applicable> !isDom() </applicable>
      </subtasks>
      <subtasks id="proposeC">
         <step name="propose" task="ProposeCriterion"/>
         <applicable> isDom() </applicable>
      </subtasks>
   </task>
   <task id="UserFirst">
      <subtasks id="userAsk">
         <step name="Uask" task="Ask"/>
      </subtasks>
      <subtasks id="UserPropose">
         <step name="Upropose" task="Propose"/>
      </subtasks>
      <subtasks id="UserState">
         <step name="Ustate" task="State"/>
      </subtasks>
   </task>
   <script init="true">

    var APPLICABLE_TEST = null; // for testing
    $state ="State";
    $ask ="Ask";   
    $negotiation = $disco.getInteraction().getSystem().getNegotiation();
    $ambiance = Packages.fr.limsi.negotiate.restaurant.Ambiance.class ;
    $restaurant = Packages.fr.limsi.negotiate.restaurant.Restaurant.class ;
    $ambiance = Packages.fr.limsi.negotiate.restaurant.Ambiance ;
   	$cuisine = Packages.fr.limsi.negotiate.restaurant.Cuisine ;
    $cost = Packages.fr.limsi.negotiate.restaurant.Cost;
    $restaurant = Packages.fr.limsi.negotiate.restaurant.Restaurant;
    $mostPrefCriterion = $negotiation.criteriaPreferences.getMostPreferred();
    $introMostPrefValue =currentMostPreferred($mostPrefCriterion, relation);
    var RI = {
  		DOMINANT : 1, 
  		PEER: 0, 
  		SUBMISSIVE : -1
		};
    var relation =RI.DOMINANT;
 	
	function isMaxStated(){
		thsld = 0;
		if(isPeer())
			thsld= 2;
		else if(isSub())
			thsld= 4;
		return ($negotiation.getContext().getCmpState()&gt;= thsld )
	}
	
    function currentMostPreferred(criterion, relation) {
       return ($negotiation.currentMostPreferredCriterion(criterion, relation));
    }
    
    function mostPreferredCriterion(criterion){
    	return ($negotiation.mostPreferredCriterion(criterion));
    }
    
    function currentMostPreferredOption() {
       return ($negotiation.currentMostPreferredOption());
    }
    
    function mostPreferredOption(){
    	return ($negotiation.mostPreferredOption());
    }
    
    function isMostPrefProposal(proposal){
    	if(isCriterionProposal(proposal))
    		return(mostPreferredCriterion(proposal.getValue().getClass()).equals(proposal.getValue()));
		
		if(isOptionProposal(proposal))
    		return(mostPreferredOption().equals(proposal.getValue()));
    }   
    
    function Preferred(criterion) {   
       		return (Packages.fr.limsi.negotiate.restaurant.Cuisine.ITALIAN);  		
    }
    
    function getLastUserPref() { 
    	if (getLastUserStatement("State") !=null)
    		return (getLastUserStatement("State").getStatedPreference());
    	
    	else 
    		return getPreference($cuisine);
    }
    
    function proposalFromUserState(userPref, relation){
    	more = userPref.getMore();
    	less = userPref.getLess();
    	if(more!= null){
    		return (isAcceptable(createProposal(more,true), relation));
    	}
    	return false;  	
    }
    
    function currentDiscussedCriterion(){
    	return ($negotiation.getContext().getCurrentDiscussedCriterion());
    }
    function getLastUserStatement(uttType){
		return $negotiation.getContext().getLastStatement(uttType, true);
	}
	
	 function getLastAgentStatement(uttType){
		return $negotiation.getContext().getLastStatement(uttType, false);
	}
	
	 function reactUser(uttType){
    	return($negotiation.reactUserStatement(uttType));
    }
 
 	
	function isCriterionProposal(proposal){
		return(proposal.class.equals(Packages.fr.limsi.negotiate.CriterionProposal.class));
	}
	
	function isOptionProposal(proposal){
		return(proposal.class.equals(Packages.fr.limsi.negotiate.OptionProposal.class));
	}
    
    function getPreference(criterion){
		return ($negotiation.getRandomPreference(criterion));
	}
	
	function sameStatement(uttType){
		 $agent  = getLastAgentStatement(uttType);
		 $user  = getLastUserStatement(uttType);
	
		if ($user == null ||  $agent == null)
			return false;
					
		if($agent.getStatedPreference().getMore() == null)
			return ($agent.getStatedPreference().getLess() == $user.getStatedPreference().getLess() 
				|| $agent.getStatedPreference().getLess() == $user.getStatedPreference().getMore()) ;
		
		if($agent.getStatedPreference().getLess() == null)
			return ($agent.getStatedPreference().getMore() == $user.getStatedPreference().getLess() 
				|| $agent.getStatedPreference().getMore() == $user.getStatedPreference().getMore()) ;
		
		if($user.getStatedPreference().getMore() == null)
			return ($user.getStatedPreference().getLess() == $agent.getStatedPreference().getLess() 
				|| $user.getStatedPreference().getLess() == $agent.getStatedPreference().getMore()) ;
		
		if($user.getStatedPreference().getLess() == null)
			return ($user.getStatedPreference().getMore() == $agent.getStatedPreference().getLess() 
				|| $user.getStatedPreference().getMore() == $agent.getStatedPreference().getMore()) ;
		
		 
		return($agent.equals($user));
	}

	function askUserPref(criterion){
		if ($negotiation.askUserPreference(criterion) == null);
			criterion = openNewCriterion();
		return($negotiation.askUserPreference(criterion));
	}
	
	
	function createProposal(value, isSelf) {
	// Enlever le  il doit etre uniquement specifier dans la maj de l'etat mental
		if(value == null)
			return null;
		return $negotiation.createProposal(value,isSelf);
	}
	
	function proposalFromPreference(preference, isSelf) {
			if (preference == null)
				return null;
			else 	{
				return createProposal(preference.getMore(), isSelf);
			}			
	}
	
	function getDiscussedCriterion(){
		return $negotiation.getContext().getCurrentDiscussedCriterion();
	}
		
	function lastRejectedProposal (){
		return ($negotiation.getContext().getLastProposal("REJECTED"));
	}
	
	function lastOpenProposal (){
		return ($negotiation.getContext().getLastProposal("OPEN"));	
	}
	
	function lastAcceptedProposal(){
			if($negotiation.getContext().getLastProposal("ACCEPTED")!=null)
				return ($negotiation.getContext().getLastProposal("ACCEPTED"));
			else
				return createProposal($more, true);
	}
	
	function getOptionWithValue(criterion){

		return $negotiation.getOptionWithValue(criterion);
	}
	
	// returns a new Critetion class  to discuss {cuisine, ambiance, cost}
	function openNewCriterion(){
		topic = $negotiation.openNewTopic();
		if(topic == null)	
			return $negotiation.criteriaPreferences.getValues().get(0);
		else 
			return topic; 
	}
	
	function getRandCriterionProp(criterion, relation){
		return ($negotiation.generateRandomCriterionProposal(criterion, relation));
	}
	
	function getRandOptionProp(){
		return ($negotiation.generateRandomOptionProposal());
	}
	
	function reactToProposal(proposal){
		if (proposal != null)
			return ($negotiation.reactToProposal(proposal));
		else
			return getPreference($cuisine);
	}
	
	function isAcceptable(proposal, relation){
		return $negotiation.isAcceptable(proposal, relation);
	}
	
	function reactToRejectedProp(proposal){
		return $negotiation.reactToRejectedProp(proposal);
	}
	
	function isDom(){
		return(relation&gt; 0)
	}
	
	function isPeer(){
		//print("ISPEER"); // pourquoi il affiche ça 4 fois quand il passe dans le 1er State ?
		return(relation== 0)
	}
	
	function isSub(){
		return (relation&lt; 0)      
 }
</script>
</taskModel>